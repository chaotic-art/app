<script setup lang="ts">
import type { AssetHubChain } from '~/plugins/sdk.client'
import { CHAINS } from '@kodadot1/static'
import { useSortOptions } from '~/composables/useSortOptions'
import { fetchOdaCollection } from '~/services/oda'
import { getSubscanAccountUrl } from '~/utils/format/address'

const route = useRoute()
const { chain: chainPrefix, collection_id } = route.params

const chain = computed(() => chainPrefix as AssetHubChain)

const { data } = await useLazyAsyncData(
  `collection:${chain.value}:${collection_id}`,
  async () => {
    const [collection, drops] = await Promise.all([
      fetchOdaCollection(chain.value, collection_id?.toString() ?? ''),
      $fetch('/api/genart/list', { query: { collection: collection_id?.toString() ?? '' } }),
    ])

    return { collection, drops }
  },
)

const { selectedSort, createQueryVariables } = useSortOptions()

const queryVariables = computed(() =>
  createQueryVariables([collection_id?.toString() ?? '']),
)

definePageMeta({
  validate: async (route) => {
    const { chain } = route.params
    return typeof chain === 'string' && chain in CHAINS
  },
})

useSeoMeta({
  title: () => data.value?.collection?.metadata?.name,
  description: () => data.value?.collection?.metadata?.description?.slice(0, 150),
})

defineOgImageComponent('Frame', {
  title: data.value?.collection?.metadata?.name,
  image: sanitizeIpfsUrl(data.value?.collection?.metadata?.image),
  items: data.value?.collection?.supply,
  claimed: data.value?.collection?.claimed,
  network: chain.value,
})
</script>

<template>
  <UContainer class="px-4 md:px-6 pb-6">
    <div>
      <!-- Banner Section -->
      <div class="relative w-full min-h-[340px] flex flex-col justify-end rounded-xl overflow-hidden">
        <div
          class="absolute inset-0 w-full h-full bg-muted"
          :style="data?.collection?.metadata?.image ? {
            backgroundImage: `url('${sanitizeIpfsUrl(data.collection.metadata.image)}')`,
            backgroundSize: 'cover',
            backgroundPosition: 'center',
          } : {}"
        />

        <div class="relative flex items-center px-8 py-8 z-10">
          <div class="flex flex-col items-center">
            <div class="w-36 h-36 rounded-xl overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 border-4 border-white dark:border-gray-900 shadow-xl">
              <img
                v-if="data?.collection?.metadata?.image"
                :src="sanitizeIpfsUrl(data.collection.metadata.image)"
                :alt="data.collection.metadata.name || 'Collection'"
                class="w-full h-full object-cover"
              >
              <div
                v-else
                class="w-full h-full flex items-center justify-center"
              >
                <UIcon name="i-heroicons-photo" class="w-12 h-12 text-gray-400" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="w-full">
        <div class="flex justify-between flex-col md:flex-row gap-12">
          <div class="flex flex-col flex-1">
            <div class="my-4">
              <div class="text-2xl font-bold mb-2">
                {{ data?.collection?.metadata?.name || `Collection #${collection_id}` }}
              </div>
              <div v-if="data?.drops?.data[0]?.creator || data?.collection?.owner" class="flex items-center gap-1 text-muted-foreground">
                <UserInfo :avatar-size="26" :address="data?.drops?.data[0]?.creator || data?.collection?.owner" custom-name>
                  <template #name="{ addressName }">
                    <div class="pr-1 flex">
                      <p>Creator:</p>
                      <p class="font-bold">
                        {{ addressName }}
                      </p>
                    </div>
                  </template>
                </UserInfo>
                <UButton
                  :to="getSubscanAccountUrl((data?.drops?.data[0]?.creator || data?.collection?.owner) ?? '', chain)"
                  target="_blank"
                >
                  Subscan
                </UButton>
                <UButton
                  v-if="data?.drops?.data[0]?.alias"
                  :to="`/${chain}/drops/${data.drops.data[0].alias}`"
                  icon="i-heroicons-sparkles"
                  variant="outline"
                >
                  View Drop: {{ data?.collection?.metadata?.name }}
                </UButton>
              </div>
            </div>

            <!-- Description -->
            <MarkdownPreview
              v-if="data?.collection?.metadata?.description"
              :source="data.collection.metadata.description"
            />
          </div>

          <!-- Quick Stats -->
          <div class="pt-4 w-auto md:w-60 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-500 dark:text-gray-400">Minted</span>
              <span class="font-medium text-gray-900 dark:text-white">{{ data?.collection?.claimed || 0 }}</span>
            </div>

            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-500 dark:text-gray-400">Supply</span>
              <span class="font-medium text-gray-900 dark:text-white">{{ unlimited(data?.collection?.supply) ? '∞' : data?.collection?.supply || 0 }}</span>
            </div>

            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-500 dark:text-gray-400">Floor Price</span>
              <span class="font-medium text-gray-900 dark:text-white">
                <Money v-if="data?.collection?.floor" inline :value="data?.collection?.floor" />
                <span v-else class="text-gray-400 dark:text-gray-500">–</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <USeparator class="my-12" />

      <!-- Items Section -->
      <div class="space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <h2 class="text-2xl md:text-3xl font-medium font-serif italic text-center md:text-left text-gray-900 dark:text-white">
            Collection Items
          </h2>

          <div class="w-full md:w-auto">
            <SortOptions
              v-model="selectedSort"
              class="w-full md:w-48"
            />
          </div>
        </div>

        <!-- Items Grid -->
        <LazyNftsGrid
          :key="selectedSort"
          :variables="queryVariables"
          grid-class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 md:gap-6"
          no-items-found-message="This collection doesn't have any items yet."
          :prefix="chain"
        />
      </div>
    </div>
  </UContainer>
</template>
